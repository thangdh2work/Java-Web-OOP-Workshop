name: CI/CD - build, test, coverage, image scan, and update deployment

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build-test-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: Build & Test with Coverage (JaCoCo)
        run: |
          mvn -q -B -DskipTests dependency:go-offline
          mvn -q -B test
      - name: Archive coverage report (JaCoCo)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

  build-and-push-image:
    needs: build-test-coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:${{ github.sha }}

  trivy-scan:
    needs: build-and-push-image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy FS scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: "fs"
          ignore-unfixed: true
          format: "sarif"
          output: "trivy-fs.sarif"
          severity: "HIGH,CRITICAL"
      - name: Run Trivy Image scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "ghcr.io/${{ github.repository }}:${{ github.sha }}"
          format: "sarif"
          output: "trivy-image.sarif"
          ignore-unfixed: true
          severity: "HIGH,CRITICAL"
      - name: Upload SARIF (Image)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-image.sarif
          category: "image-scan"
      - name: Upload SARIF (FS)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-fs.sarif
          category: "fs-scan"

  update-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure file exists
        run: |
          FILE="deploy/studentmgr/deployment.yaml"
          if [ ! -f "$FILE" ]; then
            echo "deployment.yaml not found"
            exit 1
          fi

      - name: Replace image tag in deployment.yaml
        env:
          TAG: ${{ github.event.inputs.image_tag }}
        run: |
          FILE="deploy/studentmgr/deployment.yaml"
          sed -E -i "s#(image:[[:space:]]*[^:]+:)[^[:space:],]+#\1${TAG}#g" "$FILE"
          echo "Updated $FILE:"
          sed -n '1,200p' "$FILE"

      - name: Commit and push change
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILE="deploy/studentmgr/deployment.yaml"
          if git status --porcelain | grep -q "$FILE"; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$FILE"
            git commit -m "chore(cd): update deployment image tag to ${{ github.event.inputs.image_tag }}"
            BRANCH="${GITHUB_REF#refs/heads/}"
            git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
            git push origin "HEAD:${BRANCH}"
          else
            echo "No changes to commit."
          fi
